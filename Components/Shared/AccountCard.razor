@using MDTadusMod.Data
@using MDTadusMod.Services
@using RotMGAssetExtractor.Model
@using System.Diagnostics
@inject AssetService AssetService
@inject SettingsService SettingsManager
@inject IJSRuntime JSRuntime
@inject NavigationManager NavManager
@implements IAsyncDisposable

@if (Account != null && VO != null)
{
    <div @ref="_muleContainer" class="mule" style="@($"--card-width: {_cardWidthPx}px;")">

        @if(_showWarningMessage == true){
            <div class="warning">
                <p>@AccountData.LastErrorMessage</p>
                <button @onclick="DismissWarning">X</button>
            </div>
        }

        @if (VO.Email)
        {
            <input type="text" readonly="readonly" class="guid" value="@Account.Email">
        }
        <header>
            @if (AccountData?.Star > 0)
            {
                <span class="scont">
                    <span>@(AccountData?.Star)</span>
                    <span class="star" style="color: @GetStarColor(AccountData.Star)">★</span>
                </span>
            }
            @if (VO.IGN)
            {
                <p class="mule-name" style="grid-column: 2;">@(AccountData?.Name ?? Account.Email)</p>
            }
            <div class="header-actions" style="grid-column: 3;">
                <button @onclick="EditAccount" title="Edit account">≡</button>
                <button @onclick="HandleRefreshClick" disabled="@IsRefreshing" title="Reload">↻</button>
            </div>
        </header>

        @if (!VO.Shrink && VO.Characters && (AccountData?.Characters?.Any() == true) && (
            VO.CharDescription || VO.Stats || VO.Exalts || VO.AdditionalGoals || VO.AdditionalStats || 
            VO.AdditionalBonuses || VO.Equipment || VO.Inventory || VO.Quickslots))
        {
            <div class="chars" style="--char-row-length: @_effectiveCharRowLength;">
                @{
                    IOrderedEnumerable<Character> orderedCharacters;
                    switch (VO.CharOrder)
                    {
                        case CharOrder.time:
                            orderedCharacters = AccountData.Characters.OrderByDescending(c => c.ParsedPCStats.GetValueOrDefault(20, 0L));
                            break;
                        case CharOrder.@class:
                            orderedCharacters = AccountData.Characters.OrderBy(c => c.ObjectType);
                            break;
                        case CharOrder.aliveFame:
                            orderedCharacters = AccountData.Characters.OrderByDescending(c => c.CurrentFame);
                            break;
                        case CharOrder.deadFame:
                            orderedCharacters = AccountData.Characters.OrderByDescending(c => PCStatsParser.CalculateTotalFame(c.CurrentFame, CharacterFameBonuses.GetValueOrDefault(c.Id, new List<FameBonus>())));
                            break;
                        case CharOrder.maxed:
                            orderedCharacters = AccountData.Characters.OrderByDescending(c => CharacterMaxedStatsCount.GetValueOrDefault(c.Id, 0));
                            break;
                        default:
                            orderedCharacters = AccountData.Characters.OrderBy(c => c.Id);
                            break;

                    }
                    foreach (var character in orderedCharacters)
                    {
                        <CharacterCard Character="character"
                                       VO="VO"
                                       MaxStatsPerClass="MaxStatsPerClass"
                                       ClassIdToNameMap="ClassIdToNameMap"
                                       PCStatIdToNameMap="PCStatIdToNameMap"
                                       CharacterFameBonuses="CharacterFameBonuses" />
                    }
                }
            </div>
        }

        @if (!VO.Shrink && VO.PetDescription && (AccountData?.Pets?.Any() == true))
        {
            <div class="pets" style="--char-row-length: @_effectiveCharRowLength;">
                @foreach (var pet in AccountData.Pets.OrderByDescending(p => p.Rarity).ThenByDescending(p => p.MaxAbilityPower))
                {
                    <PetCard Pet="pet" />
                }
            </div>
        }

        @if (!VO.Shrink && VO.Vaults && AccountData?.Vault?.Items?.Any() == true)
        {
            <ItemContainer Items="AccountData.Vault.Items" 
                          DisplayType="@GetDisplayType(nameof(VO.VaultsDisplayType))"
                          class="vaults" 
                          style="@($"--char-row-length: {_effectiveCharRowLength};")" />
        }

        @if (!VO.Shrink && VO.Potions && AccountData?.Potions?.Any() == true)
        {
            <ItemContainer Items="AccountData.Potions" 
                          DisplayType="@GetDisplayType(nameof(VO.PotionsDisplayType))"
                          class="potions" 
                          style="@($"--char-row-length: {_effectiveCharRowLength};")" />
        }

        @if (!VO.Shrink && VO.Materials && AccountData?.MaterialStorage?.Items?.Any() == true)
        {
            <ItemContainer Items="AccountData.MaterialStorage.Items" 
                          DisplayType="@GetDisplayType(nameof(VO.MaterialsDisplayType))"
                          class="materials" 
                          style="@($"--char-row-length: {_effectiveCharRowLength};")" />
        }

        @if (!VO.Shrink && VO.Spoils && AccountData?.TemporaryGifts?.Any() == true)
        {
            <ItemContainer Items="AccountData.TemporaryGifts" 
                          DisplayType="@GetDisplayType(nameof(VO.SpoilsDisplayType))"
                          class="spoils" 
                          style="@($"--char-row-length: {_effectiveCharRowLength};")" />
        }

        @if (!VO.Shrink && VO.Gifts && AccountData?.Gifts?.Any() == true)
        {
            <ItemContainer Items="AccountData.Gifts" 
                          DisplayType="@GetDisplayType(nameof(VO.GiftsDisplayType))"
                          class="gifts" 
                          style="@($"--char-row-length: {_effectiveCharRowLength};")" />
        }

        @if (!VO.Shrink && VO.PetInventory && AccountData?.SeasonalPetInventory?.Items?.Any() == true)
        {
            <ItemContainer Items="AccountData.SeasonalPetInventory.Items" 
                          DisplayType="@GetDisplayType(nameof(VO.PetInventoryDisplayType))"
                          class="petinv" 
                          style="@($"--char-row-length: {_effectiveCharRowLength};")" />
        }

        @if (!VO.Shrink && VO.PetInventory && AccountData?.NonSeasonalPetInventory?.Items?.Any() == true)
        {
            <ItemContainer Items="AccountData.NonSeasonalPetInventory.Items" 
                          DisplayType="@GetDisplayType(nameof(VO.PetInventoryDisplayType))"
                          class="petinv" 
                          style="@($"--char-row-length: {_effectiveCharRowLength};")" />
        }
    </div>
}

@code {
    [Parameter]
    public MDTadusMod.Data.Account Account { get; set; }

    [Parameter]
    public MDTadusMod.Data.AccountData AccountData { get; set; }

    [Parameter]
    public AccountViewOptions VO { get; set; }

    [Parameter]
    public string Status { get; set; }

    [Parameter]
    public bool IsRefreshing { get; set; }

    [Parameter]
    public EventCallback OnRefreshClicked { get; set; }

    [Parameter]
    public EventCallback OnDetailsClicked { get; set; }
    public bool displayCategoryTitle = true;

    private Dictionary<int, Dictionary<string, int>> MaxStatsPerClass;
    private Dictionary<int, string> ClassIdToNameMap = new();
    private Dictionary<int, string> PCStatIdToNameMap = new();
    private Dictionary<int, List<FameBonus>> CharacterFameBonuses = new();
    private Dictionary<int, int> CharacterMaxedStatsCount = new();

    private ElementReference _muleContainer;
    private int _effectiveCharRowLength;
    private int _cardWidthPx;
    private DotNetObjectReference<AccountCard> _dotNetObjectReference;
    private bool _showWarningMessage = false;

    private readonly Dictionary<int, string> _classNameCache = new();
    private readonly Dictionary<int, List<FameBonus>> _fameBonusCache = new();
    
    protected override async Task OnInitializedAsync()
    {
        _dotNetObjectReference = DotNetObjectReference.Create(this);
        if (VO == null)
        {
            VO = SettingsManager.GlobalOptions;
        }
        _effectiveCharRowLength = VO.CharRowLength;

        // Read width from global settings once, clamp to a reasonable range
        _cardWidthPx = Math.Clamp(SettingsManager.GlobalSettings.CardWidthPx, 100, 400);

        SettingsManager.OnChange += HandleSettingsChanged;
        MaxStatsPerClass = await AssetService.GetMaxStatsPerClass();
    }

    private void EditAccount()
    {
        if (Account?.Id != Guid.Empty)
            NavManager.NavigateTo($"/settings/accounts/edit/{Account.Id}");
    }

    private ContainerDisplayType GetDisplayType(string containerPropertyName)
    {
        // Special case: Potions behavior
        if (containerPropertyName == nameof(VO.PotionsDisplayType))
        {
            // If global setting is OFF, always use Summarized for Spoils
            if (!SettingsManager.GlobalSettings.ShowExtendedItemContainerDisplay)
            {
                // Debug: Ensure we're returning Summarized when global is OFF
                Debug.WriteLine($"[GetDisplayType] Spoils: Global setting is OFF, returning Summarized");
                return ContainerDisplayType.total;
            }
            
            // If global setting is ON, check the actual value
            var property = typeof(AccountViewOptions).GetProperty(containerPropertyName);
            if (property != null && property.GetValue(VO) is ContainerDisplayType displayType)
            {
                Debug.WriteLine($"[GetDisplayType] Spoils: Global setting is ON, returning {displayType}");
                return displayType;
            }
            Debug.WriteLine($"[GetDisplayType] Spoils: Using default Summarized");
            return ContainerDisplayType.total; // Default for Spoils
        }

        // For all other containers, respect the global setting normally
        if (!SettingsManager.GlobalSettings.ShowExtendedItemContainerDisplay)
            return ContainerDisplayType.chest;

        var prop = typeof(AccountViewOptions).GetProperty(containerPropertyName);
        if (prop != null && prop.GetValue(VO) is ContainerDisplayType type)
        {
            return type;
        }

        return ContainerDisplayType.chest;
    }

    private string GetStarColor(int stars)
    {
        if (stars >= 90) return "#fff";      // White
        if (stars >= 72) return "#ff0";      // Yellow
        if (stars >= 54) return "#f6921d";    // Orange
        if (stars >= 36) return "#c0262c";    // Red
        if (stars >= 18) return "#304cda";    // Blue
        return "#8997dd"; // Light Blue
    }

    private void DismissWarning() => _showWarningMessage = false;

    private async Task HandleRefreshClick()
    {
        DismissWarning();
        await OnRefreshClicked.InvokeAsync();
    }

    private async void HandleSettingsChanged()
    {
        try
        {
            _cardWidthPx = Math.Clamp(SettingsManager.GlobalSettings.CardWidthPx, 100, 400);
            var bodyWidth = await JSRuntime.InvokeAsync<double>("getWidth");
            OnElementResized(bodyWidth);
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"[AccountCard] Failed to recalculate row length on settings change: {ex.Message}");
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (AccountData == null) return;
        
        if (!string.IsNullOrEmpty(AccountData.LastErrorMessage)) _showWarningMessage = true;

        if (AccountData?.Characters?.Any() == true)
        {
            // Use concurrent operations for better performance
            var tasks = new List<Task>();
            
            // Batch fetch class names
            var newClassIds = AccountData.Characters
                .Select(c => c.ObjectType)
                .Distinct()
                .Where(id => !_classNameCache.ContainsKey(id))
                .ToList();
                
            if (newClassIds.Any())
            {
                tasks.Add(Task.Run(async () =>
                {
                    var results = await Task.WhenAll(newClassIds.Select(async id => 
                        new { Id = id, Name = await AssetService.GetClassNameById(id) }));
                    
                    foreach (var result in results)
                    {
                        _classNameCache[result.Id] = result.Name;
                        ClassIdToNameMap[result.Id] = result.Name;
                    }
                }));
            }

            // Batch fetch PC stat display names used by these characters
            var newStatIds = AccountData.Characters
                .Where(c => c.ParsedPCStats != null)
                .SelectMany(c => c.ParsedPCStats.Keys)
                .Distinct()
                .Where(id => !PCStatIdToNameMap.ContainsKey(id))
                .ToList();

            if (newStatIds.Any())
            {
                tasks.Add(Task.Run(async () =>
                {
                    var results = await Task.WhenAll(newStatIds.Select(async id =>
                        new { Id = id, Name = await AssetService.GetPCStatName(id) }));
                    
                    foreach (var result in results)
                    {
                        PCStatIdToNameMap[result.Id] = result.Name;
                    }
                }));
            }

            // Compute fame bonuses per character (cache + map used by CharacterCard)
            var newBonusChars = AccountData.Characters
                .Where(c => !_fameBonusCache.ContainsKey(c.Id))
                .ToList();

            if (newBonusChars.Any())
            {
                tasks.Add(Task.Run(async () =>
                {
                    var results = await Task.WhenAll(newBonusChars.Select(async c =>
                        new { c.Id, Bonuses = await PCStatsParser.EvaluateBonuses(c) }));

                    foreach (var r in results)
                    {
                        _fameBonusCache[r.Id] = r.Bonuses;
                        CharacterFameBonuses[r.Id] = r.Bonuses;
                    }
                }));
            }

            // Compute maxed stats count (used for CharOrder.maxed)
            var newMaxedChars = AccountData.Characters
                .Where(c => !CharacterMaxedStatsCount.ContainsKey(c.Id))
                .ToList();

            if (newMaxedChars.Any())
            {
                tasks.Add(Task.Run(async () =>
                {
                    var results = await Task.WhenAll(newMaxedChars.Select(async c =>
                        new { c.Id, Count = await AssetService.GetMaxedStatsCount(c) }));

                    foreach (var r in results)
                    {
                        CharacterMaxedStatsCount[r.Id] = r.Count;
                    }
                }));
            }
            
            await Task.WhenAll(tasks);

            // Ensure CharacterFameBonuses is fully populated from cache
            foreach (var c in AccountData.Characters)
            {
                if (_fameBonusCache.TryGetValue(c.Id, out var bonuses))
                {
                    CharacterFameBonuses[c.Id] = bonuses;
                }
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("observeResize", _dotNetObjectReference, _muleContainer);
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    [JSInvokable]
    public void OnElementResized(double bodyWidth)
    {
        if (VO == null) return;

        var somethingChanged = false;

        // --- Character Row Calculation ---
        if (VO.Characters && bodyWidth > 0)
        {
            int newEffectiveLength;

            if (AccountData?.Characters?.Any() == true)
            {
                // Use global per-column width
                var cardWidth = (double)Math.Clamp(_cardWidthPx, 100, 400);
                const double gap = 0;
                const double safetyMargin = 20;

                var effectiveWidth = bodyWidth - safetyMargin;
                var maxFit = Math.Floor((effectiveWidth + gap) / (cardWidth + gap));
                var newLength = Math.Min(VO.CharRowLength, (int)maxFit);
                newLength = Math.Min(newLength, AccountData.Characters.Count);
                newEffectiveLength = Math.Max(1, newLength);
            }
            else
            {
                // If there are no characters, default the length to 1.
                newEffectiveLength = 1;
            }

            if (newEffectiveLength != _effectiveCharRowLength)
            {
                _effectiveCharRowLength = newEffectiveLength;
                somethingChanged = true;
            }
        }

        if (somethingChanged)
        {
            StateHasChanged();
        }
    }

    public async ValueTask DisposeAsync()
    {
        SettingsManager.OnChange -= HandleSettingsChanged;
        if (_muleContainer.Id != null)
        {
            await JSRuntime.InvokeVoidAsync("unobserveResize", _muleContainer);
        }
        _dotNetObjectReference?.Dispose();
    }
}