@using MDTadusMod.Data
@using MDTadusMod.Services
@using RotMGAssetExtractor.Model
@using System.Diagnostics
@inject AssetService AssetService
@inject SettingsService SettingsManager
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

@if (Account != null && ViewOptions != null)
{
    <div @ref="_muleContainer" class="mule">

        @if(_showWarningMessage == true){
            <div class="warning">
                <p>@AccountData.LastErrorMessage</p>
                <button @onclick="DismissWarning">X</button>
            </div>
        }
        


        @if (ViewOptions.Email)
        {
            <input type="text" readonly="readonly" class="guid" value="@Account.Email">
        }
        <header>
            @if (AccountData?.Star > 0)
            {
                <span class="scont">
                    <span>@(AccountData?.Star)</span>
                    <span class="star" style="color: @GetStarColor(AccountData.Star)">★</span>
                </span>
            }
            @if (ViewOptions.IGN)
            {
                <p class="mule-name" style="grid-column: 2;">@(AccountData?.Name ?? Account.Email)</p>
            }
            <button @onclick="HandleRefreshClick" disabled="@IsRefreshing" style="grid-column: 3;">
                ↻
            </button>
        </header>

        @if (!ViewOptions.Shrink && ViewOptions.Characters && (AccountData?.Characters?.Any() == true))
        {
            <div class="chars" style="--char-row-length: @_effectiveCharRowLength;">
                @{
                    IOrderedEnumerable<Character> orderedCharacters;
                    switch (ViewOptions.CharOrder)
                    {
                        case CharOrder.time:
                            orderedCharacters = AccountData.Characters.OrderByDescending(c => c.ParsedPCStats.GetValueOrDefault(20, 0L));
                            break;
                        case CharOrder.@class:
                            orderedCharacters = AccountData.Characters.OrderBy(c => c.ObjectType);
                            break;
                        case CharOrder.aliveFame:
                            orderedCharacters = AccountData.Characters.OrderByDescending(c => c.CurrentFame);
                            break;
                        case CharOrder.deadFame:
                            orderedCharacters = AccountData.Characters.OrderByDescending(c => PCStatsParser.CalculateTotalFame(c.CurrentFame, CharacterFameBonuses.GetValueOrDefault(c.Id, new List<FameBonus>())));
                            break;
                        case CharOrder.maxed:
                            orderedCharacters = AccountData.Characters.OrderByDescending(c => CharacterMaxedStatsCount.GetValueOrDefault(c.Id, 0));
                            break;
                        default:
                            orderedCharacters = AccountData.Characters.OrderBy(c => c.Id);
                            break;

                    }
                    foreach (var character in orderedCharacters)
                    {
                        <CharacterCard Character="character"
                                       ViewOptions="ViewOptions"
                                       MaxStatsPerClass="MaxStatsPerClass"
                                       ClassIdToNameMap="ClassIdToNameMap"
                                       PCStatIdToNameMap="PCStatIdToNameMap"
                                       CharacterFameBonuses="CharacterFameBonuses" />
                    }
                }
            </div>
        }

        @if (!ViewOptions.Shrink && ViewOptions.PetDescription && (AccountData?.Pets?.Any() == true))
        {
            <div class="pets" style="--char-row-length: @_effectiveCharRowLength;">
                @foreach (var pet in AccountData.Pets.OrderByDescending(p => p.Rarity).ThenByDescending(p => p.MaxAbilityPower))
                {
                    <PetCard Pet="pet" />
                }
            </div>
        }


        @if (!ViewOptions.Shrink && ViewOptions.Vaults && AccountData?.Vault?.Items?.Any() == true)
        {
            <ItemContainer Items="AccountData.Vault.Items" 
                          DisplayType="@GetDisplayType(nameof(ViewOptions.VaultsDisplayType))"
                          class="vaults" 
                          style="@($"--char-row-length: {_effectiveCharRowLength};")" />
        }

        @if (!ViewOptions.Shrink && ViewOptions.Potions && AccountData?.Potions?.Any() == true)
        {
            <ItemContainer Items="AccountData.Potions" 
                          DisplayType="@GetDisplayType(nameof(ViewOptions.PotionsDisplayType))"
                          class="potions" 
                          style="@($"--char-row-length: {_effectiveCharRowLength};")" />
        }

        @if (!ViewOptions.Shrink && ViewOptions.Materials && AccountData?.MaterialStorage?.Items?.Any() == true)
        {
            <ItemContainer Items="AccountData.MaterialStorage.Items" 
                          DisplayType="@GetDisplayType(nameof(ViewOptions.MaterialsDisplayType))"
                          class="materials" 
                          style="@($"--char-row-length: {_effectiveCharRowLength};")" />
        }

        @if (!ViewOptions.Shrink && ViewOptions.Spoils && AccountData?.TemporaryGifts?.Any() == true)
        {
            <ItemContainer Items="AccountData.TemporaryGifts" 
                          DisplayType="@GetDisplayType(nameof(ViewOptions.SpoilsDisplayType))"
                          class="spoils" 
                          style="@($"--char-row-length: {_effectiveCharRowLength};")" />
        }

        @if (!ViewOptions.Shrink && ViewOptions.Gifts && AccountData?.Gifts?.Any() == true)
        {
            <ItemContainer Items="AccountData.Gifts" 
                          DisplayType="@GetDisplayType(nameof(ViewOptions.GiftsDisplayType))"
                          class="gifts" 
                          style="@($"--char-row-length: {_effectiveCharRowLength};")" />
        }

        @if (!ViewOptions.Shrink && ViewOptions.PetInventory && AccountData?.SeasonalPetInventory?.Items?.Any() == true)
        {
            <ItemContainer Items="AccountData.SeasonalPetInventory.Items" 
                          DisplayType="@GetDisplayType(nameof(ViewOptions.PetInventoryDisplayType))"
                          class="petinv" 
                          style="@($"--char-row-length: {_effectiveCharRowLength};")" />
        }

        @if (!ViewOptions.Shrink && ViewOptions.PetInventory && AccountData?.NonSeasonalPetInventory?.Items?.Any() == true)
        {
            <ItemContainer Items="AccountData.NonSeasonalPetInventory.Items" 
                          DisplayType="@GetDisplayType(nameof(ViewOptions.PetInventoryDisplayType))"
                          class="petinv" 
                          style="@($"--char-row-length: {_effectiveCharRowLength};")" />
        }
    </div>
}


@code {
    [Parameter]
    public MDTadusMod.Data.Account Account { get; set; }

    [Parameter]
    public MDTadusMod.Data.AccountData AccountData { get; set; }

    [Parameter]
    public AccountViewOptions ViewOptions { get; set; }

    [Parameter]
    public string Status { get; set; }

    [Parameter]
    public bool IsRefreshing { get; set; }

    [Parameter]
    public EventCallback OnRefreshClicked { get; set; }

    [Parameter]
    public EventCallback OnDetailsClicked { get; set; }
    public bool displayCategoryTitle = true;

    private Dictionary<int, Dictionary<string, int>> MaxStatsPerClass;
    private Dictionary<int, string> ClassIdToNameMap = new();
    private Dictionary<int, string> PCStatIdToNameMap = new();
    private Dictionary<int, List<FameBonus>> CharacterFameBonuses = new();
    private Dictionary<int, int> CharacterMaxedStatsCount = new();

    private ElementReference _muleContainer;
    private int _effectiveCharRowLength;
    private DotNetObjectReference<AccountCard> _dotNetObjectReference;
	private bool _showWarningMessage = false;


    // Add caching for expensive calculations
    private readonly Dictionary<int, string> _classNameCache = new();
    private readonly Dictionary<int, List<FameBonus>> _fameBonusCache = new();
    
    protected override async Task OnInitializedAsync()
    {
        _dotNetObjectReference = DotNetObjectReference.Create(this);
        // Fallback if the parameter is not provided
        if (ViewOptions == null)
        {
            ViewOptions = SettingsManager.GlobalOptions;
        }
        // Set initial value from settings to prevent starting at 1
        _effectiveCharRowLength = ViewOptions.CharRowLength;
        SettingsManager.OnChange += HandleSettingsChanged;
        MaxStatsPerClass = await AssetService.GetMaxStatsPerClass();
    }

    private ContainerDisplayType GetDisplayType(string containerPropertyName)
    {
        // Special case: Potions behavior
        if (containerPropertyName == nameof(ViewOptions.PotionsDisplayType))
        {
            // If global setting is OFF, always use Summarized for Spoils
            if (!SettingsManager.GlobalSettings.ShowExtendedItemContainerDisplay)
            {
                // Debug: Ensure we're returning Summarized when global is OFF
                Debug.WriteLine($"[GetDisplayType] Spoils: Global setting is OFF, returning Summarized");
                return ContainerDisplayType.total;
            }
            
            // If global setting is ON, check the actual value
            var property = typeof(AccountViewOptions).GetProperty(containerPropertyName);
            if (property != null && property.GetValue(ViewOptions) is ContainerDisplayType displayType)
            {
                Debug.WriteLine($"[GetDisplayType] Spoils: Global setting is ON, returning {displayType}");
                return displayType;
            }
            Debug.WriteLine($"[GetDisplayType] Spoils: Using default Summarized");
            return ContainerDisplayType.total; // Default for Spoils
        }

        // For all other containers, respect the global setting normally
        if (!SettingsManager.GlobalSettings.ShowExtendedItemContainerDisplay)
            return ContainerDisplayType.chest;

        var prop = typeof(AccountViewOptions).GetProperty(containerPropertyName);
        if (prop != null && prop.GetValue(ViewOptions) is ContainerDisplayType type)
        {
            return type;
        }

        return ContainerDisplayType.chest;
    }

    private string GetStarColor(int stars)
    {
        if (stars >= 90) return "#fff";      // White
        if (stars >= 72) return "#ff0";      // Yellow
        if (stars >= 54) return "#f6921d";    // Orange
        if (stars >= 36) return "#c0262c";    // Red
        if (stars >= 18) return "#304cda";    // Blue
        return "#8997dd"; // Light Blue
    }

    private void DismissWarning() => _showWarningMessage = false;

    private async Task HandleRefreshClick()
    {
        DismissWarning();
        await OnRefreshClicked.InvokeAsync();
    }

    private async void HandleSettingsChanged()
    {
        try
        {
            var containerWidth = await JSRuntime.InvokeAsync<double>("getWidth");
            OnElementResized(containerWidth);
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"[AccountCard] Failed to recalc on settings change: {ex.Message}");
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (AccountData == null) return;
        
        if (!string.IsNullOrEmpty(AccountData.LastErrorMessage)) _showWarningMessage = true;

        if (AccountData?.Characters?.Any() == true)
        {
            // Use concurrent operations for better performance
            var tasks = new List<Task>();
            
            // Batch fetch class names
            var newClassIds = AccountData.Characters
                .Select(c => c.ObjectType)
                .Distinct()
                .Where(id => !_classNameCache.ContainsKey(id))
                .ToList();
                
            if (newClassIds.Any())
            {
                tasks.Add(Task.Run(async () =>
                {
                    var results = await Task.WhenAll(newClassIds.Select(async id => 
                        new { Id = id, Name = await AssetService.GetClassNameById(id) }));
                    
                    foreach (var result in results)
                    {
                        _classNameCache[result.Id] = result.Name;
                        ClassIdToNameMap[result.Id] = result.Name;
                    }
                }));
            }
            
            // Similar optimization for other data fetching...
            await Task.WhenAll(tasks);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("observeResize", _dotNetObjectReference, _muleContainer);
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    [JSInvokable]
    public void OnElementResized(double bodyWidth)
    {
        if (ViewOptions == null) return;

        var somethingChanged = false;

        // --- Character Row Calculation ---
        if (ViewOptions.Characters && bodyWidth > 0)
        {
            int newEffectiveLength;

            if (AccountData?.Characters?.Any() == true)
            {
                // Calculate length based on screen size and character count
                const double cardWidth = 180;
                const double gap = 0;
                const double safetyMargin = 20;

                var effectiveWidth = bodyWidth - safetyMargin;
                var maxFit = Math.Floor((effectiveWidth + gap) / (cardWidth + gap));
                var newLength = Math.Min(ViewOptions.CharRowLength, (int)maxFit);
                newLength = Math.Min(newLength, AccountData.Characters.Count);
                newEffectiveLength = Math.Max(1, newLength);
            }
            else
            {
                // If there are no characters, default the length to 1.
                newEffectiveLength = 1;
            }

            if (newEffectiveLength != _effectiveCharRowLength)
            {
                _effectiveCharRowLength = newEffectiveLength;
                somethingChanged = true;
            }
        }

        if (somethingChanged)
        {
            StateHasChanged();
        }
    }

    public async ValueTask DisposeAsync()
    {
        SettingsManager.OnChange -= HandleSettingsChanged;
        if (_muleContainer.Id != null)
        {
            await JSRuntime.InvokeVoidAsync("unobserveResize", _muleContainer);
        }
        _dotNetObjectReference?.Dispose();
    }
}